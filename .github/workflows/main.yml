name: å¹³è¡¡å‹-Windows-è¿œç¨‹è¿æ¥-ä¿®å¤ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string
      rdp_password:
        description: 'è¿œç¨‹æ¡Œé¢è¿æ¥å¯†ç ï¼ˆè‡³å°‘8ä½å­—ç¬¦ï¼‰'
        required: true
        type: string
        default: 'GitHubRDP123!'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€
        run: |
          Write-Host "============================================="
          Write-Host "åˆå§‹ç³»ç»ŸçŠ¶æ€"
          Write-Host "============================================="
          Write-Host "å†…å­˜ä¿¡æ¯ï¼š"
          systeminfo | findstr /C:"ç‰©ç†å†…å­˜" || echo "æ— æ³•è·å–è¯¦ç»†å†…å­˜ä¿¡æ¯"
          Write-Host ""
          Write-Host "ç£ç›˜ä¿¡æ¯ï¼š"
          Get-PSDrive C | Format-Table Name, @{Name="Used(GB)"; Expression={[math]::Round($_.Used/1GB, 2)}}, @{Name="Free(GB)"; Expression={[math]::Round($_.Free/1GB, 2)}} -AutoSize
          Write-Host ""
          
      - name: åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶å’Œæ–‡ä»¶
        run: |
          Write-Host "============================================="
          Write-Host "æ¸…ç†ç³»ç»Ÿç©ºé—´"
          Write-Host "============================================="
          
          # è·å–æ¸…ç†å‰ç©ºé—´
          $BeforeSpace = (Get-PSDrive C).Free
          Write-Host "æ¸…ç†å‰å¯ç”¨ç©ºé—´: $([math]::Round($BeforeSpace/1GB, 2)) GB"
          
          try {
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
              Remove-Item -Path "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
              Remove-Item -Path "C:\Windows\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
              
              # æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜
              Write-Host "æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜..."
              Remove-Item -Path "$env:USERPROFILE\AppData\Local\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
              
              # æ¸…ç†Dockeré•œåƒ
              Write-Host "æ¸…ç†Dockeré•œåƒ..."
              docker system prune -a -f 2>$null
              
              Write-Host "æ¸…ç†å®Œæˆ"
          } catch {
              Write-Host "æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ: $($_.Exception.Message)"
          }
          
          # è·å–æ¸…ç†åç©ºé—´
          $AfterSpace = (Get-PSDrive C).Free
          $FreedSpace = $AfterSpace - $BeforeSpace
          Write-Host "é‡Šæ”¾ç©ºé—´: $([math]::Round($FreedSpace/1GB, 2)) GB"
          Write-Host "æ¸…ç†åå¯ç”¨ç©ºé—´: $([math]::Round($AfterSpace/1GB, 2)) GB"
          
      - name: é…ç½®è¿œç¨‹æ¡Œé¢è¿æ¥
        run: |
          Write-Host "============================================="
          Write-Host "é…ç½®è¿œç¨‹æ¡Œé¢è¿æ¥"
          Write-Host "============================================="
          
          # è®¾ç½®è¿œç¨‹æ¡Œé¢å¯†ç 
          $password = "${{ inputs.rdp_password }}"
          
          try {
              # å¯ç”¨è¿œç¨‹æ¡Œé¢
              Write-Host "å¯ç”¨è¿œç¨‹æ¡Œé¢æœåŠ¡..."
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -ErrorAction Stop
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1 -ErrorAction Stop
              
              # é…ç½®é˜²ç«å¢™å…è®¸RDP
              Write-Host "é…ç½®é˜²ç«å¢™è§„åˆ™..."
              netsh advfirewall firewall set rule group="remote desktop" new enable=Yes 2>$null
              
              # è®¾ç½®å½“å‰ç”¨æˆ·å¯†ç ï¼ˆä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼‰
              Write-Host "è®¾ç½®å½“å‰ç”¨æˆ·å¯†ç ..."
              $computer = [ADSI]"WinNT://$env:COMPUTERNAME"
              $user = $computer.Children | Where-Object { $_.SchemaClassName -eq 'User' -and $_.Name -eq $env:USERNAME }
              if ($user) {
                  $user.SetPassword($password)
                  $user.CommitChanges()
                  Write-Host "å½“å‰ç”¨æˆ·å¯†ç è®¾ç½®æˆåŠŸ"
              }
              
              Write-Host "è¿œç¨‹æ¡Œé¢é…ç½®å®Œæˆ"
          } catch {
              Write-Host "é…ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: $($_.Exception.Message)"
              Write-Host "å°è¯•å¤‡ç”¨é…ç½®æ–¹æ¡ˆ..."
              
              # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨netå‘½ä»¤
              netsh advfirewall firewall add rule name="Open RDP Port 3389" dir=in action=allow protocol=TCP localport=3389 2>$null
          }
          
          # è·å–IPä¿¡æ¯
          $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -like "10.*" -or $_.IPAddress -like "172.*" -or $_.IPAddress -like "192.168.*"} | Select-Object -First 1).IPAddress
          if (-not $ipAddress) {
              $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"} | Select-Object -First 1).IPAddress
          }
          
          Write-Host "è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯ï¼š"
          Write-Host "IPåœ°å€: $ipAddress"
          Write-Host "ç”¨æˆ·å: $env:USERNAME"
          Write-Host "å¯†ç : [æ‚¨è®¾ç½®çš„å¯†ç ]"
          Write-Host "ç«¯å£: 3389"
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ˜¾ç¤ºä¼˜åŒ–ç»“æœå’Œè¿æ¥ä¿¡æ¯
        run: |
          Write-Host "============================================="
          Write-Host "âœ… Windowså¹³è¡¡å‹ä¼˜åŒ–å®Œæˆ"
          Write-Host "============================================="
          Write-Host ""
          Write-Host "ğŸ“Š ç£ç›˜çŠ¶æ€ï¼š"
          Get-PSDrive C | Format-Table Name, @{Name="Used(GB)"; Expression={[math]::Round($_.Used/1GB, 2)}}, @{Name="Free(GB)"; Expression={[math]::Round($_.Free/1GB, 2)}}, @{Name="Total(GB)"; Expression={[math]::Round(($_.Used + $_.Free)/1GB, 2)}} -AutoSize
          Write-Host ""
          Write-Host "ğŸ§  å†…å­˜ä¿¡æ¯ï¼š"
          systeminfo | findstr /C:"ç‰©ç†å†…å­˜" || Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object TotalVisibleMemorySize, FreePhysicalMemory | Format-Table -AutoSize
          Write-Host ""
          
          # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
          $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -like "10.*" -or $_.IPAddress -like "172.*" -or $_.IPAddress -like "192.168.*"} | Select-Object -First 1).IPAddress
          if (-not $ipAddress) {
              $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"} | Select-Object -First 1).IPAddress
          }
          
          Write-Host "ğŸ”— è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯ï¼š"
          Write-Host "IPåœ°å€: $ipAddress"
          Write-Host "ç”¨æˆ·å: $env:USERNAME"
          Write-Host "ç«¯å£: 3389"
          Write-Host "============================================="
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          if (Test-Path "start.bat") {
              Write-Host "æ­£åœ¨å¯åŠ¨åº”ç”¨..."
              Start-Process -FilePath "start.bat" -WindowStyle Normal
          } elseif (Test-Path "start.ps1") {
              Write-Host "æ­£åœ¨å¯åŠ¨PowerShellåº”ç”¨..."
              Start-Process -FilePath "powershell" -ArgumentList "-File start.ps1" -WindowStyle Normal
          } else {
              Write-Host "ä¿¡æ¯ï¼šæœªæ‰¾åˆ° start.bat æˆ– start.ps1 æ–‡ä»¶ï¼Œè·³è¿‡åº”ç”¨å¯åŠ¨"
          }
          
      - name: ä¿æŒå·¥ä½œæµè¿è¡Œå¹¶æä¾›è¿œç¨‹è¿æ¥
        run: |
          Write-Host "============================================="
          Write-Host "ğŸš€ å¯åŠ¨ä¿æ´»è¿›ç¨‹å’Œè¿œç¨‹æ¡Œé¢æœåŠ¡"
          Write-Host "============================================="
          
          $DurationMinutes = ${{ inputs.duration }}
          $DurationSeconds = $DurationMinutes * 60
          
          Write-Host "â±ï¸  è®¾ç½®è¿è¡Œæ—¶é•¿: $DurationMinutes åˆ†é’Ÿ"
          Write-Host ""
          
          # ç¡®ä¿è¿œç¨‹æ¡Œé¢æœåŠ¡è¿è¡Œ
          try {
              Write-Host "å¯åŠ¨è¿œç¨‹æ¡Œé¢æœåŠ¡..."
              Start-Service -Name "TermService" -ErrorAction Stop
              Start-Service -Name "UmRdpService" -ErrorAction SilentlyContinue
              Write-Host "è¿œç¨‹æ¡Œé¢æœåŠ¡å¯åŠ¨æˆåŠŸ"
          } catch {
              Write-Host "è¿œç¨‹æ¡Œé¢æœåŠ¡å¯åŠ¨è­¦å‘Š: $($_.Exception.Message)"
          }
          
          $StartTime = Get-Date
          $EndTime = $StartTime.AddMinutes($DurationMinutes)
          $Iteration = 0
          
          while ($true) {
              $Iteration++
              $CurrentTime = Get-Date
              $Elapsed = ($CurrentTime - $StartTime).TotalSeconds
              $Remaining = ($EndTime - $CurrentTime).TotalSeconds
            
              if ($Remaining -le 0) {
                  Write-Host "============================================="
                  Write-Host "â° å·²è¾¾åˆ°è®¾ç½®çš„è¿è¡Œæ—¶é•¿"
                  Write-Host "============================================="
                  Write-Host "è¿è¡Œäº† $DurationMinutes åˆ†é’Ÿï¼Œç°åœ¨é€€å‡º"
                  break
              }
            
              $MinutesRemaining = [math]::Round($Remaining / 60, 1)
              $MinutesElapsed = [math]::Round($Elapsed / 60, 1)
              Write-Host "[è¿­ä»£ $Iteration] å·²è¿è¡Œ: $MinutesElapsed åˆ†é’Ÿ, å‰©ä½™: $MinutesRemaining åˆ†é’Ÿ"
            
              # å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆæ¯5æ¬¡è¿­ä»£æ£€æŸ¥ä¸€æ¬¡ï¼‰
              if ($Iteration % 5 -eq 0) {
                  $TermService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                  if ($TermService.Status -ne "Running") {
                      Write-Host "é‡æ–°å¯åŠ¨è¿œç¨‹æ¡Œé¢æœåŠ¡..."
                      Start-Service -Name "TermService" -ErrorAction SilentlyContinue
                  }
              }
            
              Start-Sleep -Seconds 30
          }
          
      - name: å®‰å…¨æ¸…ç†
        if: always()
        run: |
          Write-Host "============================================="
          Write-Host "ğŸ§¹ å®‰å…¨æ¸…ç†é˜¶æ®µ"
          Write-Host "============================================="
          
          try {
              Write-Host "ç¦ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥..."
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -ErrorAction SilentlyContinue
              Write-Host "è¿œç¨‹æ¡Œé¢å·²ç¦ç”¨"
              
              Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
              Remove-Item -Path "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
              Write-Host "æ¸…ç†å®Œæˆ"
              
          } catch {
              Write-Host "æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°éå…³é”®é”™è¯¯: $($_.Exception.Message)"
              Write-Host "ç»§ç»­å®Œæˆå·¥ä½œæµ..."
          }
          
          Write-Host "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæ¯•"
