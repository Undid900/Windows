name: å¹³è¡¡å‹-Windows-ä¿®å¤ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string
      rdp_password:
        description: 'è¿œç¨‹æ¡Œé¢è¿æ¥å¯†ç '
        required: true
        type: string
        default: 'GitHubRDP123'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€æ£€æŸ¥
        run: |
          Write-Host "============================================="
          Write-Host "âœ… ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¼€å§‹"
          Write-Host "============================================="
          
          # ç®€å•ç¨³å®šçš„ç£ç›˜æ£€æŸ¥
          try {
              $drive = Get-PSDrive C
              $usedGB = [math]::Round($drive.Used / 1GB, 2)
              $freeGB = [math]::Round($drive.Free / 1GB, 2)
              Write-Host "Cç›˜ç©ºé—´ - å·²ç”¨: ${usedGB}GB, å¯ç”¨: ${freeGB}GB"
          } catch {
              Write-Host "ç£ç›˜æ£€æŸ¥å®Œæˆ"
          }
          
          Write-Host "âœ… ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"

      - name: æ¸…ç†ç³»ç»Ÿç©ºé—´
        run: |
          Write-Host "============================================="
          Write-Host "ğŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´"
          Write-Host "============================================="
          
          # å®‰å…¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          Remove-Item -Path "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
          Remove-Item -Path "C:\Windows\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          Write-Host "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: é…ç½®è¿œç¨‹æ¡Œé¢æœåŠ¡
        run: |
          Write-Host "============================================="
          Write-Host "ğŸ”§ é…ç½®è¿œç¨‹æ¡Œé¢æœåŠ¡"
          Write-Host "============================================="
          
          # å¯ç”¨è¿œç¨‹æ¡Œé¢
          Write-Host "å¯ç”¨è¿œç¨‹æ¡Œé¢..."
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
          
          # é…ç½®é˜²ç«å¢™
          Write-Host "é…ç½®é˜²ç«å¢™..."
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389 2>$null
          
          # è·å–IPåœ°å€
          $ip = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          Write-Host "è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯:"
          Write-Host "IPåœ°å€: $ip"
          Write-Host "ç«¯å£: 3389"
          
          # ç”ŸæˆRDPæ–‡ä»¶å†…å®¹ - ä¿®å¤YAMLè¯­æ³•é”™è¯¯
          $rdpContent = "screen mode id:i:2" + "`n" +
                       "use multimon:i:0" + "`n" +
                       "desktopwidth:i:1280" + "`n" +
                       "desktopheight:i:720" + "`n" +
                       "session bpp:i:32" + "`n" +
                       "winposstr:s:0,1,0,0,800,600" + "`n" +
                       "compression:i:1" + "`n" +
                       "keyboardhook:i:2" + "`n" +
                       "audiocapturemode:i:0" + "`n" +
                       "videoplaybackmode:i:1"
          
          $rdpContent | Out-File -FilePath "connection.rdp" -Encoding ASCII
          Write-Host "âœ… RDPæ–‡ä»¶å·²ç”Ÿæˆ"

      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: åˆ›å»ºè¿æ¥ä¿¡æ¯é¡µé¢
        run: |
          $ip = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          $password = "${{ inputs.rdp_password }}"
          
          # åˆ›å»ºç®€åŒ–çš„HTMLé¡µé¢
          $htmlContent = @"
<!DOCTYPE html>
<html>
<head>
    <title>Windows è¿œç¨‹æ¡Œé¢è¿æ¥</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .info { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 15px 0; }
        code { background: #f1f1f1; padding: 2px 5px; border-radius: 3px; }
        .btn { background: #007acc; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Windows è¿œç¨‹æ¡Œé¢è¿æ¥</h1>
        <div class="info">
            <h3>è¿æ¥ä¿¡æ¯ï¼š</h3>
            <p><strong>IPåœ°å€:</strong> <code>$ip</code></p>
            <p><strong>ç«¯å£:</strong> <code>3389</code></p>
            <p><strong>ç”¨æˆ·å:</strong> <code>runneradmin</code></p>
        </div>
        <a href="connection.rdp" class="btn" download>ğŸ“¥ ä¸‹è½½RDPæ–‡ä»¶</a>
        <p>ä¸‹è½½ååŒå‡»RDPæ–‡ä»¶å³å¯è¿æ¥</p>
    </div>
</body>
</html>
"@
          
          $htmlContent | Out-File -FilePath "connect.html" -Encoding UTF8
          Write-Host "âœ… è¿æ¥é¡µé¢å·²åˆ›å»º"

      - name: æ˜¾ç¤ºæœ€ç»ˆä¿¡æ¯
        run: |
          $ip = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          
          Write-Host ""
          Write-Host "============================================="
          Write-Host "ğŸ‰ ç³»ç»Ÿé…ç½®å®Œæˆï¼"
          Write-Host "============================================="
          Write-Host ""
          Write-Host "ğŸ”— è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯ï¼š"
          Write-Host "   IPåœ°å€: $ip"
          Write-Host "   ç«¯å£: 3389"
          Write-Host "   ç”¨æˆ·å: runneradmin"
          Write-Host ""
          Write-Host "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          Write-Host "   â€¢ connection.rdp (RDPè¿æ¥æ–‡ä»¶)"
          Write-Host "   â€¢ connect.html (è¿æ¥è¯´æ˜)"
          Write-Host ""
          Write-Host "â° è¿è¡Œæ—¶é•¿: ${{ inputs.duration }} åˆ†é’Ÿ"
          Write-Host "============================================="

      - name: ä¿æŒå·¥ä½œæµè¿è¡Œ
        run: |
          $duration = ${{ inputs.duration }}
          Write-Host "ä¿æŒè¿è¡Œ $duration åˆ†é’Ÿ..."
          
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes($duration)
          $counter = 0
          
          while ((Get-Date) -lt $endTime) {
              $counter++
              $elapsed = (Get-Date) - $startTime
              $remaining = $endTime - (Get-Date)
              
              Write-Host "[$counter] å·²è¿è¡Œ: $([math]::Round($elapsed.TotalMinutes, 1))m, å‰©ä½™: $([math]::Round($remaining.TotalMinutes, 1))m"
              Start-Sleep -Seconds 30
          }
          
          Write-Host "âœ… è¿è¡Œæ—¶é—´ç»“æŸ"
