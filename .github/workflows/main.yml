name: å¹³è¡¡å‹-Windows-è¿œç¨‹è¿æ¥

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string
      rdp_password:
        description: 'è¿œç¨‹æ¡Œé¢è¿æ¥å¯†ç ï¼ˆè‡³å°‘8ä½å­—ç¬¦ï¼‰'
        required: true
        type: string
        default: 'GitHubRDP123!'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€
        run: |
          Write-Host "============================================="
          Write-Host "åˆå§‹ç³»ç»ŸçŠ¶æ€"
          Write-Host "============================================="
          Write-Host "å†…å­˜ä¿¡æ¯ï¼š"
          systeminfo | findstr "ç‰©ç†å†…å­˜"
          Write-Host ""
          Write-Host "ç£ç›˜ä¿¡æ¯ï¼š"
          Get-PSDrive C
          Write-Host ""
          
      - name: åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶å’Œæ–‡ä»¶
        run: |
          Write-Host "============================================="
          Write-Host "æ¸…ç†ç³»ç»Ÿç©ºé—´"
          Write-Host "============================================="
          
          # è·å–æ¸…ç†å‰ç©ºé—´
          $BeforeSpace = (Get-PSDrive C).Free
          Write-Host "æ¸…ç†å‰å¯ç”¨ç©ºé—´: $([math]::Round($BeforeSpace/1GB, 2)) GB"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          Remove-Item -Path "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
          Remove-Item -Path "C:\Windows\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          
          # æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜
          Write-Host "æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜..."
          Remove-Item -Path "$env:USERPROFILE\AppData\Local\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          
          # æ¸…ç†NuGetç¼“å­˜
          Write-Host "æ¸…ç†NuGetç¼“å­˜..."
          Remove-Item -Path "$env:USERPROFILE\.nuget\packages\*" -Force -Recurse -ErrorAction SilentlyContinue 2>$null
          
          # æ¸…ç†Dockeré•œåƒ
          Write-Host "æ¸…ç†Dockeré•œåƒ..."
          docker system prune -a -f 2>$null
          
          # è¿è¡Œç£ç›˜æ¸…ç†
          Write-Host "è¿è¡Œç£ç›˜æ¸…ç†..."
          CleanMgr /sagerun:1 | Out-Null
          
          # è·å–æ¸…ç†åç©ºé—´
          $AfterSpace = (Get-PSDrive C).Free
          $FreedSpace = $AfterSpace - $BeforeSpace
          Write-Host "é‡Šæ”¾ç©ºé—´: $([math]::Round($FreedSpace/1GB, 2)) GB"
          Write-Host "æ¸…ç†åå¯ç”¨ç©ºé—´: $([math]::Round($AfterSpace/1GB, 2)) GB"
          
      - name: é…ç½®è¿œç¨‹æ¡Œé¢è¿æ¥
        run: |
          Write-Host "============================================="
          Write-Host "é…ç½®è¿œç¨‹æ¡Œé¢è¿æ¥"
          Write-Host "============================================="
          
          # è®¾ç½®è¿œç¨‹æ¡Œé¢å¯†ç 
          $password = "${{ inputs.rdp_password }}"
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          
          # å¯ç”¨ç®¡ç†å‘˜è´¦æˆ·
          Write-Host "å¯ç”¨ç®¡ç†å‘˜è´¦æˆ·..."
          net user administrator /active:yes
          net user administrator $password
          
          # å¯ç”¨è¿œç¨‹æ¡Œé¢
          Write-Host "å¯ç”¨è¿œç¨‹æ¡Œé¢..."
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1
          
          # é…ç½®é˜²ç«å¢™å…è®¸RDP
          Write-Host "é…ç½®é˜²ç«å¢™..."
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          
          # è·å–IPä¿¡æ¯
          $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -like "*Ethernet*"} | Select-Object -First 1).IPAddress
          Write-Host "è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯ï¼š"
          Write-Host "IPåœ°å€: $ipAddress"
          Write-Host "ç”¨æˆ·å: administrator"
          Write-Host "å¯†ç : $password"
          Write-Host "ç«¯å£: 3389"
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ˜¾ç¤ºä¼˜åŒ–ç»“æœå’Œè¿æ¥ä¿¡æ¯
        run: |
          Write-Host "============================================="
          Write-Host "âœ… Windowså¹³è¡¡å‹ä¼˜åŒ–å®Œæˆ"
          Write-Host "============================================="
          Write-Host ""
          Write-Host "ğŸ“Š ç£ç›˜çŠ¶æ€ï¼š"
          Get-PSDrive C | Format-Table Name, Used, Free, @{Name="Free(GB)"; Expression={[math]::Round($_.Free/1GB, 2)}}, @{Name="Total(GB)"; Expression={[math]::Round($_.Used/1GB + $_.Free/1GB, 2)}}
          Write-Host ""
          Write-Host "ğŸ§  å†…å­˜ä¿¡æ¯ï¼š"
          systeminfo | findstr "ç‰©ç†å†…å­˜"
          Write-Host ""
          
          # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
          $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -like "*Ethernet*"} | Select-Object -First 1).IPAddress
          Write-Host "ğŸ”— è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯ï¼š"
          Write-Host "IPåœ°å€: $ipAddress"
          Write-Host "ç”¨æˆ·å: administrator"
          Write-Host "ç«¯å£: 3389"
          Write-Host "============================================="
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          if (Test-Path "start.bat") {
            Write-Host "æ­£åœ¨å¯åŠ¨åº”ç”¨..."
            Start-Process -FilePath "start.bat" -WindowStyle Normal
          } elseif (Test-Path "start.ps1") {
            Write-Host "æ­£åœ¨å¯åŠ¨PowerShellåº”ç”¨..."
            Start-Process -FilePath "powershell" -ArgumentList "-File start.ps1" -WindowStyle Normal
          } else {
            Write-Host "è­¦å‘Šï¼šæœªæ‰¾åˆ° start.bat æˆ– start.ps1 æ–‡ä»¶ï¼Œè·³è¿‡åº”ç”¨å¯åŠ¨"
          }
          
      - name: ä¿æŒå·¥ä½œæµè¿è¡Œå¹¶æä¾›è¿œç¨‹è¿æ¥
        run: |
          Write-Host "============================================="
          Write-Host "ğŸš€ å¯åŠ¨ä¿æ´»è¿›ç¨‹å’Œè¿œç¨‹æ¡Œé¢æœåŠ¡"
          Write-Host "============================================="
          
          $DurationMinutes = ${{ inputs.duration }}
          $DurationSeconds = $DurationMinutes * 60
          
          Write-Host "â±ï¸  è®¾ç½®è¿è¡Œæ—¶é•¿: $DurationMinutes åˆ†é’Ÿ"
          Write-Host ""
          
          # ç¡®ä¿è¿œç¨‹æ¡Œé¢æœåŠ¡è¿è¡Œ
          Write-Host "å¯åŠ¨è¿œç¨‹æ¡Œé¢æœåŠ¡..."
          Start-Service -Name "TermService" -ErrorAction SilentlyContinue
          Start-Service -Name "UmRdpService" -ErrorAction SilentlyContinue
          
          $StartTime = Get-Date
          $EndTime = $StartTime.AddMinutes($DurationMinutes)
          $Iteration = 0
          
          while ($true) {
            $Iteration++
            $CurrentTime = Get-Date
            $Elapsed = ($CurrentTime - $StartTime).TotalSeconds
            $Remaining = ($EndTime - $CurrentTime).TotalSeconds
            
            if ($Remaining -le 0) {
                Write-Host "============================================="
                Write-Host "â° å·²è¾¾åˆ°è®¾ç½®çš„è¿è¡Œæ—¶é•¿"
                Write-Host "============================================="
                Write-Host "è¿è¡Œäº† $DurationMinutes åˆ†é’Ÿï¼Œç°åœ¨é€€å‡º"
                break
            }
            
            $MinutesRemaining = [math]::Round($Remaining / 60, 1)
            Write-Host "[è¿­ä»£ $Iteration] å·²è¿è¡Œ: $([math]::Round($Elapsed/60, 1)) åˆ†é’Ÿ, å‰©ä½™: $MinutesRemaining åˆ†é’Ÿ"
            
            # æ£€æŸ¥è¿œç¨‹æ¡Œé¢æœåŠ¡çŠ¶æ€
            $TermService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
            if ($TermService.Status -ne "Running") {
                Write-Host "é‡æ–°å¯åŠ¨è¿œç¨‹æ¡Œé¢æœåŠ¡..."
                Start-Service -Name "TermService"
            }
            
            Start-Sleep -Seconds 30
          }
          
      - name: æ¸…ç†å’Œå…³é—­è¿œç¨‹æ¡Œé¢
        if: always()
        run: |
          Write-Host "============================================="
          Write-Host "ğŸ§¹ æ¸…ç†é˜¶æ®µ"
          Write-Host "============================================="
          
          Write-Host "ç¦ç”¨è¿œç¨‹æ¡Œé¢..."
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1
          
          Write-Host "ç¦ç”¨ç®¡ç†å‘˜è´¦æˆ·..."
          net user administrator /active:no
          
          Write-Host "æ¸…ç†å®Œæˆ"
