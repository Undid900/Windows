name: å¹³è¡¡å‹-Windows-è¿œç¨‹è¿æ¥-æœ€ç»ˆä¿®å¤ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string
      rdp_password:
        description: 'è¿œç¨‹æ¡Œé¢è¿æ¥å¯†ç ï¼ˆè‡³å°‘8ä½å­—ç¬¦ï¼‰'
        required: true
        type: string
        default: 'GitHubRDP123!'

env:
  ERROR_ACTION: continue

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€
        run: |
          Write-Host "============================================="
          Write-Host "åˆå§‹ç³»ç»ŸçŠ¶æ€"
          Write-Host "============================================="
          Write-Host "å†…å­˜ä¿¡æ¯ï¼š"
          
          # ä¿®å¤å†…å­˜ä¿¡æ¯è·å– - ä½¿ç”¨å¤šç§æ–¹æ³•
          try {
              $memInfo = systeminfo 2>$null | Select-String "ç‰©ç†å†…å­˜"
              if ($memInfo) {
                  $memInfo
              } else {
                  Write-Host "ä½¿ç”¨WMIè·å–å†…å­˜ä¿¡æ¯..."
                  $os = Get-CimInstance Win32_OperatingSystem
                  $totalMem = [math]::Round($os.TotalVisibleMemorySize/1MB, 2)
                  $freeMem = [math]::Round($os.FreePhysicalMemory/1MB, 2)
                  Write-Host "æ€»ç‰©ç†å†…å­˜: ${totalMem} GB"
                  Write-Host "å¯ç”¨ç‰©ç†å†…å­˜: ${freeMem} GB"
              }
          } catch {
              Write-Host "å†…å­˜ä¿¡æ¯: ä½¿ç”¨å¤‡ç”¨æ–¹æ³•è·å–"
              $cs = Get-CimInstance Win32_ComputerSystem
              $totalGB = [math]::Round($cs.TotalPhysicalMemory/1GB, 2)
              Write-Host "æ€»å†…å­˜: ${totalGB} GB"
          }
          
          Write-Host ""
          Write-Host "ç£ç›˜ä¿¡æ¯ï¼š"
          try {
              $cDrive = Get-PSDrive C
              $usedGB = [math]::Round($cDrive.Used/1GB, 2)
              $freeGB = [math]::Round($cDrive.Free/1GB, 2)
              Write-Host "Cç›˜ - å·²ç”¨: ${usedGB} GB, å¯ç”¨: ${freeGB} GB"
          } catch {
              Write-Host "ç£ç›˜ä¿¡æ¯è·å–å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          }
          
          Write-Host ""
          Write-Host "âœ… ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ"
          
      - name: åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶å’Œæ–‡ä»¶
        run: |
          Write-Host "============================================="
          Write-Host "æ¸…ç†ç³»ç»Ÿç©ºé—´"
          Write-Host "============================================="
          
          # è·å–æ¸…ç†å‰ç©ºé—´
          try {
              $BeforeSpace = (Get-PSDrive C).Free
              Write-Host "æ¸…ç†å‰å¯ç”¨ç©ºé—´: $([math]::Round($BeforeSpace/1GB, 2)) GB"
          } catch {
              Write-Host "æ— æ³•è·å–åˆå§‹ç©ºé—´ä¿¡æ¯ï¼Œç»§ç»­æ¸…ç†è¿‡ç¨‹..."
              $BeforeSpace = 0
          }
          
          # å®‰å…¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          Remove-Item -Path "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
          Remove-Item -Path "C:\Windows\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:USERPROFILE\AppData\Local\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          
          # å°è¯•æ¸…ç†Dockeré•œåƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (Get-Command docker -ErrorAction SilentlyContinue) {
              Write-Host "æ¸…ç†Dockeré•œåƒ..."
              docker system prune -a -f 2>$null
          }
          
          # è®¡ç®—é‡Šæ”¾ç©ºé—´
          try {
              $AfterSpace = (Get-PSDrive C).Free
              if ($BeforeSpace -gt 0) {
                  $FreedSpace = $AfterSpace - $BeforeSpace
                  Write-Host "é‡Šæ”¾ç©ºé—´: $([math]::Round($FreedSpace/1GB, 2)) GB"
              }
              Write-Host "å½“å‰å¯ç”¨ç©ºé—´: $([math]::Round($AfterSpace/1GB, 2)) GB"
          } catch {
              Write-Host "ç©ºé—´ç»Ÿè®¡å®Œæˆ"
          }
          
      - name: é…ç½®è¿œç¨‹æ¡Œé¢è¿æ¥
        run: |
          Write-Host "============================================="
          Write-Host "é…ç½®è¿œç¨‹æ¡Œé¢è¿æ¥"
          Write-Host "============================================="
          
          $password = "${{ inputs.rdp_password }}"
          
          try {
              # å¯ç”¨è¿œç¨‹æ¡Œé¢
              Write-Host "å¯ç”¨è¿œç¨‹æ¡Œé¢æœåŠ¡..."
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -ErrorAction Stop
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -ErrorAction Stop
              
              # é…ç½®é˜²ç«å¢™
              Write-Host "é…ç½®é˜²ç«å¢™è§„åˆ™..."
              netsh advfirewall firewall set rule group="è¿œç¨‹æ¡Œé¢" new enable=Yes 2>$null
              if ($LASTEXITCODE -ne 0) {
                  netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389 2>$null
              }
              
              Write-Host "è¿œç¨‹æ¡Œé¢é…ç½®å®Œæˆ"
          } catch {
              Write-Host "è­¦å‘Š: éƒ¨åˆ†é…ç½®å¯èƒ½å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ - $($_.Exception.Message)"
          }
          
          # è·å–IPä¿¡æ¯
          try {
              $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {
                  $_.IPAddress -like "10.*" -or 
                  $_.IPAddress -like "172.*" -or 
                  $_.IPAddress -like "192.168.*"
              } | Select-Object -First 1).IPAddress
              
              if (-not $ipAddress) {
                  $ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {
                      $_.InterfaceAlias -notlike "*Loopback*"
                  } | Select-Object -First 1).IPAddress
              }
              
              Write-Host "è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯ï¼š"
              Write-Host "IPåœ°å€: $ipAddress"
              Write-Host "ç«¯å£: 3389"
          } catch {
              Write-Host "æ— æ³•è·å–IPåœ°å€ï¼Œè¯·æŸ¥çœ‹å·¥ä½œæµè¿è¡Œè¯¦æƒ…è·å–è¿æ¥ä¿¡æ¯"
          }
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
        run: |
          Write-Host "============================================="
          Write-Host "âœ… ç³»ç»Ÿå‡†å¤‡å®Œæˆ"
          Write-Host "============================================="
          
          try {
              $cDrive = Get-PSDrive C
              $usedGB = [math]::Round($cDrive.Used/1GB, 2)
              $freeGB = [math]::Round($cDrive.Free/1GB, 2)
              $totalGB = [math]::Round(($cDrive.Used + $cDrive.Free)/1GB, 2)
              
              Write-Host "ğŸ“Š ç£ç›˜çŠ¶æ€ï¼š"
              Write-Host "Cç›˜ - æ€»è®¡: ${totalGB} GB, å·²ç”¨: ${usedGB} GB, å¯ç”¨: ${freeGB} GB"
          } catch {
              Write-Host "ç£ç›˜ä¿¡æ¯: è·å–æˆåŠŸ"
          }
          
          Write-Host ""
          Write-Host "ğŸ”— è¿œç¨‹æ¡Œé¢å·²å¯ç”¨"
          Write-Host "ä½¿ç”¨Windowsè¿œç¨‹æ¡Œé¢è¿æ¥å·¥å…·è¿æ¥åˆ°æ­¤å®ä¾‹"
          Write-Host ""
          Write-Host "â±ï¸  ä¿æ´»æ—¶é•¿: ${{ inputs.duration }} åˆ†é’Ÿ"
          Write-Host "============================================="
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          Write-Host "æ£€æŸ¥å¯åŠ¨è„šæœ¬..."
          if (Test-Path "start.bat") {
              Write-Host "æ‰¾åˆ°start.batï¼Œæ­£åœ¨å¯åŠ¨..."
              Start-Process -FilePath "cmd.exe" -ArgumentList "/c start.bat" -WindowStyle Normal -Wait
          } elseif (Test-Path "start.ps1") {
              Write-Host "æ‰¾åˆ°start.ps1ï¼Œæ­£åœ¨å¯åŠ¨..."
              Start-Process -FilePath "powershell.exe" -ArgumentList "-File start.ps1" -WindowStyle Normal -Wait
          } else {
              Write-Host "æœªæ‰¾åˆ°å¯åŠ¨è„šæœ¬ï¼Œè·³è¿‡åº”ç”¨å¯åŠ¨"
          }
          
      - name: ä¿æŒè¿è¡Œå¹¶æä¾›è¿œç¨‹è¿æ¥
        run: |
          Write-Host "============================================="
          Write-Host "ğŸš€ å¯åŠ¨ä¿æ´»è¿›ç¨‹"
          Write-Host "============================================="
          
          $DurationMinutes = ${{ inputs.duration }}
          Write-Host "è®¾ç½®è¿è¡Œæ—¶é•¿: $DurationMinutes åˆ†é’Ÿ"
          Write-Host ""
          
          # å¯åŠ¨è¿œç¨‹æ¡Œé¢æœåŠ¡
          try {
              Start-Service "TermService" -ErrorAction SilentlyContinue
              Write-Host "è¿œç¨‹æ¡Œé¢æœåŠ¡å·²å¯åŠ¨"
          } catch {
              Write-Host "è¿œç¨‹æ¡Œé¢æœåŠ¡çŠ¶æ€: å·²é…ç½®"
          }
          
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes($DurationMinutes)
          $iteration = 0
          
          while ($true) {
              $iteration++
              $currentTime = Get-Date
              $remaining = $endTime - $currentTime
              
              if ($remaining.TotalSeconds -le 0) {
                  Write-Host "â° è¿è¡Œæ—¶é—´ç»“æŸï¼Œé€€å‡ºä¿æ´»è¿›ç¨‹"
                  break
              }
              
              $minutesElapsed = [math]::Round(($currentTime - $startTime).TotalMinutes, 1)
              $minutesRemaining = [math]::Round($remaining.TotalMinutes, 1)
              
              Write-Host "è¿è¡Œä¸­... å·²è¿‡: ${minutesElapsed}åˆ†é’Ÿ, å‰©ä½™: ${minutesRemaining}åˆ†é’Ÿ"
              
              # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
              if ($iteration % 10 -eq 0) {
                  try {
                      $service = Get-Service "TermService" -ErrorAction SilentlyContinue
                      if ($service.Status -ne "Running") {
                          Start-Service "TermService" -ErrorAction SilentlyContinue
                      }
                  } catch {
                      # å¿½ç•¥æœåŠ¡æ£€æŸ¥é”™è¯¯
                  }
              }
              
              Start-Sleep -Seconds 30
          }
          
      - name: æ¸…ç†é˜¶æ®µ
        if: always()
        run: |
          Write-Host "============================================="
          Write-Host "ğŸ§¹ æ¸…ç†é˜¶æ®µ"
          Write-Host "============================================="
          
          try {
              Write-Host "ç¦ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥..."
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -ErrorAction SilentlyContinue
              Write-Host "æ¸…ç†å®Œæˆ"
          } catch {
              Write-Host "æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°éå…³é”®é”™è¯¯"
          }
          
          Write-Host "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæ¯•"
