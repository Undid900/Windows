name: å¹³è¡¡å‹-ARM-ä¿®å¤ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€
        run: |
          echo "============================================="
          echo "åˆå§‹ç³»ç»ŸçŠ¶æ€"
          echo "============================================="
          echo "å†…å­˜å’Œäº¤æ¢ç©ºé—´ï¼š"
          free -h
          echo ""
          echo "å¯ç”¨å­˜å‚¨ï¼š"
          df -h
          echo ""
          
      - name: åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶
        run: |
          set -e
          
          echo "============================================="
          echo "åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶"
          echo "============================================="
          echo ""
          
          # è®°å½•å¼€å§‹ç©ºé—´
          SPACE_BEFORE=$(df / | awk 'NR==2 {print $4}')
          
          # å®‰å…¨åˆ é™¤å‡½æ•°
          safe_remove() {
            local target="$1"
            local name="$2"
            if [ -e "$target" ] || [ -d "$target" ]; then
              echo -n "åˆ é™¤ $name... "
              if sudo rm -rf "$target" 2>/dev/null; then
                echo "å®Œæˆ"
              else
                echo "å¤±è´¥ï¼ˆæ— æƒé™æˆ–ä¸å­˜åœ¨ï¼‰"
              fi
            else
              echo "è·³è¿‡ $nameï¼ˆä¸å­˜åœ¨ï¼‰"
            fi
          }
          
          # æ¸…ç†APTåŒ…
          echo "æ¸…ç†APTåŒ…..."
          sudo apt-get autoremove -y > /dev/null 2>&1 || true
          sudo apt-get clean > /dev/null 2>&1 || true
          
          # åˆ é™¤å¤§ç›®å½•
          safe_remove "/usr/share/dotnet" "Dotnet"
          safe_remove "/usr/local/lib/android" "Android SDK" 
          safe_remove "/opt/hostedtoolcache" "å·¥å…·ç¼“å­˜"
          safe_remove "/usr/local/lib/node_modules" "Nodeæ¨¡å—"
          
          # è®°å½•ç»“æŸç©ºé—´
          SPACE_AFTER=$(df / | awk 'NR==2 {print $4}')
          SPACE_FREED=$((SPACE_AFTER - SPACE_BEFORE))
          echo ""
          echo "é‡Šæ”¾ç©ºé—´: $((SPACE_FREED / 1024)) MB"
          echo ""
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        run: |
          echo "============================================="
          echo "âœ… ä¼˜åŒ–å®Œæˆ"
          echo "============================================="
          echo ""
          echo "ğŸ“Š å­˜å‚¨çŠ¶æ€ï¼š"
          df -h | grep -E '(Filesystem|/$)'
          echo ""
          echo "ğŸ§  å†…å­˜çŠ¶æ€ï¼š"
          free -h
          echo ""
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          if [ -f "requirements.txt" ]; then
            echo "å®‰è£…Pythonä¾èµ–..."
            pip install -r requirements.txt
          fi
          
          if [ -f "package.json" ]; then
            echo "å®‰è£…Node.jsä¾èµ–..."
            npm install
          fi
          
          if [ -f "start.sh" ]; then
            echo "å¯åŠ¨åº”ç”¨..."
            chmod +x start.sh
            ./start.sh &
          elif [ -f "main.py" ]; then
            echo "å¯åŠ¨Pythonåº”ç”¨..."
            python main.py &
          elif [ -f "app.js" ]; then
            echo "å¯åŠ¨Node.jsåº”ç”¨..."
            node app.js &
          else
            echo "æœªæ‰¾åˆ°å¯å¯åŠ¨çš„åº”ç”¨æ–‡ä»¶"
          fi
          
      - name: ä¿æŒå·¥ä½œæµè¿è¡Œ
        run: |
          echo "============================================="
          echo "å¯åŠ¨ä¿æ´»è¿›ç¨‹"
          echo "============================================="
          echo ""
          
          # ä»è¾“å…¥è·å–æ—¶é•¿
          DURATION_MINUTES=${{ inputs.duration }}
          DURATION_SECONDS=$((DURATION_MINUTES * 60))
          
          echo "è®¾ç½®è¿è¡Œæ—¶é•¿: ${DURATION_MINUTES} åˆ†é’Ÿ"
          echo ""
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          END_TIME=$((START_TIME + DURATION_SECONDS))
          
          # ç®€å•çš„ç­‰å¾…å¾ªç¯
          while [ $(date +%s) -lt $END_TIME ]; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((END_TIME - CURRENT_TIME))
            
            ELAPSED_MIN=$((ELAPSED / 60))
            REMAINING_MIN=$((REMAINING / 60))
            
            echo "[$(date '+%H:%M:%S')] å·²è¿è¡Œ: ${ELAPSED_MIN}åˆ†é’Ÿ, å‰©ä½™: ${REMAINING_MIN}åˆ†é’Ÿ"
            
            # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
            sleep 30
          done
          
          echo "============================================="
          echo "è¿è¡Œå®Œæˆï¼Œæ€»æ—¶é•¿: ${DURATION_MINUTES} åˆ†é’Ÿ"
          echo "============================================="
