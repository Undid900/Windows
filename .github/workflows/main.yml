name: å¹³è¡¡å‹-Windows-è¿œç¨‹è¿æ¥-ç¨³å®šç‰ˆ

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string
      rdp_password:
        description: 'è¿œç¨‹æ¡Œé¢è¿æ¥å¯†ç '
        required: true
        type: string
        default: 'GitHubRDP123'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€æ£€æŸ¥
        run: |
          Write-Host "============================================="
          Write-Host "ç³»ç»ŸçŠ¶æ€æ£€æŸ¥"
          Write-Host "============================================="
          
          # ç®€åŒ–ç³»ç»Ÿæ£€æŸ¥ï¼Œé¿å…å¤±è´¥
          Write-Host "æ£€æŸ¥ç£ç›˜ç©ºé—´..."
          try {
              $drive = Get-PSDrive C -ErrorAction Stop
              $usedGB = [math]::Round($drive.Used / 1GB, 2)
              $freeGB = [math]::Round($drive.Free / 1GB, 2)
              Write-Host "âœ… Cç›˜ç©ºé—´ - å·²ç”¨: ${usedGB}GB, å¯ç”¨: ${freeGB}GB"
          } catch {
              Write-Host "âš ï¸  æ— æ³•è·å–ç£ç›˜ä¿¡æ¯ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
          }
          
          Write-Host "âœ… ç³»ç»Ÿæ£€æŸ¥å®Œæˆ"
          
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶ä¸­..."
          Remove-Item -Path "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
          Remove-Item -Path "C:\Windows\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          Write-Host "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
          
      - name: é…ç½®è¿œç¨‹æ¡Œé¢
        run: |
          Write-Host "============================================="
          Write-Host "é…ç½®è¿œç¨‹æ¡Œé¢æœåŠ¡"
          Write-Host "============================================="
          
          # å¯ç”¨è¿œç¨‹æ¡Œé¢
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
          
          # é…ç½®é˜²ç«å¢™
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          # è·å–IPåœ°å€
          $ip = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          Write-Host "è¿œç¨‹æ¡Œé¢è¿æ¥ä¿¡æ¯ï¼š"
          Write-Host "IPåœ°å€: $ip"
          Write-Host "ç«¯å£: 3389"
          
          # ç”ŸæˆRDPæ–‡ä»¶å†…å®¹
          $rdpContent = @"
screen mode id:i:2
use multimon:i:0
desktopwidth:i:1280
desktopheight:i:720
session bpp:i:32
winposstr:s:0,1,0,0,800,600
compression:i:1
keyboardhook:i:2
audiocapturemode:i:0
videoplaybackmode:i:1
connection type:i:7
networkautodetect:i:1
bandwidthautodetect:i:1
displayconnectionbar:i:1
enableworkspacereconnect:i:0
disable wallpaper:i:0
allow font smoothing:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:1
full address:s:$ip
audiomode:i:0
redirectprinters:i:1
redirectcomports:i:0
redirectsmartcards:i:1
redirectclipboard:i:1
redirectposdevices:i:0
autoreconnection enabled:i:1
authentication level:i:2
prompt for credentials:i:0
negotiate security layer:i:1
remoteapplicationmode:i:0
alternate shell:s:
shell working directory:s:
gatewayhostname:s:
gatewayusagemethod:i:4
gatewaycredentialssource:i:4
gatewayprofileusagemethod:i:0
promptcredentialonce:i:0
gatewaybrokeringtype:i:0
use redirection server name:i:0
rdgiskdcproxy:i:0
kdcproxyname:s:
drivestoredirect:s:*
"@
          
          # ä¿å­˜RDPæ–‡ä»¶
          $rdpContent | Out-File -FilePath "connection.rdp" -Encoding ASCII
          Write-Host "âœ… å·²ç”ŸæˆRDPè¿æ¥æ–‡ä»¶"
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: åˆ›å»ºè¿æ¥ä¿¡æ¯é¡µé¢
        run: |
          # è·å–IPåœ°å€
          $ip = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          
          # åˆ›å»ºHTMLè¿æ¥é¡µé¢
          $htmlContent = @"
<!DOCTYPE html>
<html>
<head>
    <title>Windows è¿œç¨‹æ¡Œé¢è¿æ¥</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container { 
            background: rgba(255,255,255,0.1); 
            padding: 30px; 
            border-radius: 15px; 
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .info-box { 
            background: rgba(255,255,255,0.2); 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 10px; 
            border-left: 4px solid #4CAF50;
        }
        .btn { 
            display: inline-block; 
            padding: 12px 24px; 
            background: #4CAF50; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 10px 5px; 
            transition: background 0.3s;
        }
        .btn:hover { background: #45a049; }
        .step { margin: 20px 0; }
        code { 
            background: rgba(0,0,0,0.3); 
            padding: 10px; 
            border-radius: 5px; 
            display: block; 
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Windows è¿œç¨‹æ¡Œé¢è¿æ¥</h1>
        
        <div class="info-box">
            <h2>ğŸ“¡ è¿æ¥ä¿¡æ¯</h2>
            <p><strong>IPåœ°å€:</strong> <code id="ip-address">$ip</code></p>
            <p><strong>ç«¯å£:</strong> <code>3389</code></p>
            <p><strong>ç”¨æˆ·å:</strong> <code>runneradmin</code></p>
            <p><strong>å¯†ç :</strong> <code>${{ inputs.rdp_password }}</code></p>
        </div>

        <div class="step">
            <h2>ğŸ”— å¿«é€Ÿè¿æ¥æ–¹å¼</h2>
            <a href="connection.rdp" class="btn" download="github-rdp.rdp">ğŸ“¥ ä¸‹è½½RDPæ–‡ä»¶</a>
            <button class="btn" onclick="copyIP()">ğŸ“‹ å¤åˆ¶IPåœ°å€</button>
        </div>

        <div class="step">
            <h2>ğŸ“‹ æ‰‹åŠ¨è¿æ¥æ­¥éª¤</h2>
            <ol>
                <li>æ‰“å¼€Windowsè¿œç¨‹æ¡Œé¢è¿æ¥å·¥å…· (mstsc.exe)</li>
                <li>è¾“å…¥è®¡ç®—æœºåœ°å€: <code>$ip:3389</code></li>
                <li>ç”¨æˆ·å: <code>runneradmin</code></li>
                <li>å¯†ç : <code>${{ inputs.rdp_password }}</code></li>
            </ol>
        </div>

        <div class="info-box">
            <h2>â±ï¸ ä¼šè¯ä¿¡æ¯</h2>
            <p><strong>å‰©ä½™æ—¶é—´:</strong> <span id="countdown">${{ inputs.duration }}</span> åˆ†é’Ÿ</p>
            <p><strong>å¼€å§‹æ—¶é—´:</strong> <span id="start-time">$(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</span></p>
        </div>
    </div>

    <script>
        function copyIP() {
            const ip = document.getElementById('ip-address').textContent;
            navigator.clipboard.writeText(ip).then(() => {
                alert('IPåœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + ip);
            });
        }

        // å€’è®¡æ—¶åŠŸèƒ½
        let minutes = ${{ inputs.duration }};
        const countdownEl = document.getElementById('countdown');
        setInterval(() => {
            if (minutes > 0) {
                minutes--;
                countdownEl.textContent = minutes;
            }
        }, 60000);
    </script>
</body>
</html>
"@
          
          $htmlContent | Out-File -FilePath "connection.html" -Encoding UTF8
          Write-Host "âœ… è¿æ¥ä¿¡æ¯é¡µé¢å·²åˆ›å»º"
          
      - name: å¯åŠ¨WebæœåŠ¡å™¨æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
        run: |
          # å¯åŠ¨ç®€å•çš„HTTPæœåŠ¡å™¨æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
          $htmlPath = Join-Path $pwd "connection.html"
          $rdpPath = Join-Path $pwd "connection.rdp"
          
          Write-Host "ğŸŒ å¯åŠ¨æœ¬åœ°WebæœåŠ¡å™¨æ˜¾ç¤ºè¿æ¥ä¿¡æ¯..."
          Write-Host "è¿æ¥æ–‡ä»¶: $htmlPath"
          Write-Host "RDPæ–‡ä»¶: $rdpPath"
          
          # åœ¨åå°å¯åŠ¨Python HTTPæœåŠ¡å™¨ï¼ˆå¦‚æœPythonå¯ç”¨ï¼‰
          $python = Get-Command python -ErrorAction SilentlyContinue
          if ($python) {
              Start-Process python -ArgumentList "-m", "http.server", "8080" -WindowStyle Hidden
              Write-Host "âœ… WebæœåŠ¡å™¨å·²å¯åŠ¨åœ¨ç«¯å£ 8080"
          } else {
              Write-Host "âš ï¸  Pythonä¸å¯ç”¨ï¼Œè·³è¿‡WebæœåŠ¡å™¨å¯åŠ¨"
          }
          
      - name: æ˜¾ç¤ºæœ€ç»ˆè¿æ¥ä¿¡æ¯
        run: |
          $ip = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          
          Write-Host ""
          Write-Host "============================================="
          Write-Host "ğŸ‰ è¿œç¨‹æ¡Œé¢é…ç½®å®Œæˆï¼"
          Write-Host "============================================="
          Write-Host ""
          Write-Host "ğŸ“Š è¿æ¥ä¿¡æ¯æ±‡æ€»ï¼š"
          Write-Host "    IPåœ°å€: $ip"
          Write-Host "    ç«¯å£: 3389"
          Write-Host "    ç”¨æˆ·å: runneradmin"
          Write-Host "    å¯†ç : ${{ inputs.rdp_password }}"
          Write-Host ""
          Write-Host "ğŸ”— å¿«é€Ÿè¿æ¥æ–¹å¼ï¼š"
          Write-Host "    1. ä¸‹è½½ connection.rdp æ–‡ä»¶ç›´æ¥è¿æ¥"
          Write-Host "    2. æŸ¥çœ‹ connection.html è·å–è¯¦ç»†è¯´æ˜"
          Write-Host ""
          Write-Host "â° ä¼šè¯æ—¶é•¿: ${{ inputs.duration }} åˆ†é’Ÿ"
          Write-Host "============================================="
          
      - name: ä¿æŒä¼šè¯æ´»è·ƒ
        run: |
          $duration = ${{ inputs.duration }}
          Write-Host "ä¿æŒä¼šè¯æ´»è·ƒ $duration åˆ†é’Ÿ..."
          
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes($duration)
          
          # ç¡®ä¿è¿œç¨‹æ¡Œé¢æœåŠ¡è¿è¡Œ
          Start-Service "TermService" -ErrorAction SilentlyContinue
          
          $counter = 0
          while ((Get-Date) -lt $endTime) {
              $counter++
              $elapsed = (Get-Date) - $startTime
              $remaining = $endTime - (Get-Date)
              
              Write-Host "[$counter] å·²è¿è¡Œ: $([math]::Round($elapsed.TotalMinutes, 1))m, å‰©ä½™: $([math]::Round($remaining.TotalMinutes, 1))m"
              
              # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
              if ($counter % 10 -eq 0) {
                  $service = Get-Service "TermService" -ErrorAction SilentlyContinue
                  if ($service.Status -ne "Running") {
                      Start-Service "TermService"
                  }
              }
              
              Start-Sleep -Seconds 30
          }
          
          Write-Host "âœ… ä¼šè¯æ—¶é—´ç»“æŸ"
