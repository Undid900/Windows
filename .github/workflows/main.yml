name: å¹³è¡¡å‹-Windows-RDP

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string
      rdp_password:
        description: 'RDPè¿œç¨‹è¿æ¥å¯†ç ï¼ˆæœ€å°‘8ä½ï¼‰'
        required: true
        default: 'GitHubRDP123!'
        type: string

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€
        run: |
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "åˆå§‹ç³»ç»ŸçŠ¶æ€" -ForegroundColor Cyan
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "å†…å­˜ä¿¡æ¯ï¼š" -ForegroundColor Yellow
          systeminfo | Select-String "Total Physical Memory"
          Write-Host ""
          Write-Host "ç£ç›˜ä¿¡æ¯ï¼š" -ForegroundColor Yellow
          Get-PSDrive C | Format-Table Name, Used, Free, @{Name="Free(GB)"; Expression={[math]::Round($_.Free/1GB,2)}}, @{Name="Used(GB)"; Expression={[math]::Round($_.Used/1GB,2)}}
          Write-Host ""
          
      - name: æ¸…ç†ç³»ç»Ÿç©ºé—´
        run: |
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "æ¸…ç†ç³»ç»Ÿç©ºé—´" -ForegroundColor Cyan
          Write-Host "=============================================" -ForegroundColor Cyan
          
          # è·å–æ¸…ç†å‰ç©ºé—´
          $before = Get-PSDrive C | Select-Object -ExpandProperty Free
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..." -ForegroundColor Yellow
          Remove-Item -Path "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          # æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜
          Write-Host "æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜..." -ForegroundColor Yellow
          Remove-Item -Path "$env:LOCALAPPDATA\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          # æ¸…ç†NuGetç¼“å­˜
          Write-Host "æ¸…ç†NuGetç¼“å­˜..." -ForegroundColor Yellow
          Remove-Item -Path "$env:USERPROFILE\.nuget\packages\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          # è¿è¡Œç£ç›˜æ¸…ç†
          Write-Host "è¿è¡Œç£ç›˜æ¸…ç†..." -ForegroundColor Yellow
          Cleanmgr /sagerun:1 | Out-Null
          
          # è·å–æ¸…ç†åç©ºé—´
          $after = Get-PSDrive C | Select-Object -ExpandProperty Free
          $freedGB = [math]::Round(($after - $before)/1GB, 2)
          
          Write-Host "é‡Šæ”¾ç©ºé—´: $freedGB GB" -ForegroundColor Green
          
      - name: è®¾ç½®RDPè¿œç¨‹æ¡Œé¢
        run: |
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "è®¾ç½®RDPè¿œç¨‹æ¡Œé¢" -ForegroundColor Cyan
          Write-Host "=============================================" -ForegroundColor Cyan
          
          # è®¾ç½®ç”¨æˆ·å¯†ç 
          $password = ConvertTo-SecureString "${{ inputs.rdp_password }}" -AsPlainText -Force
          $user = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name.Split('\')[1]
          Set-LocalUser -Name $user -Password $password
          
          # å¯ç”¨RDP
          Write-Host "å¯ç”¨è¿œç¨‹æ¡Œé¢..." -ForegroundColor Yellow
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
          
          # é…ç½®é˜²ç«å¢™ - ä¿®å¤æ˜¾ç¤ºç»„åç§°
          Write-Host "é…ç½®é˜²ç«å¢™..." -ForegroundColor Yellow
          # ä½¿ç”¨è‹±æ–‡çš„æ˜¾ç¤ºç»„åç§°
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          # åŒæ—¶æ·»åŠ ç«¯å£è§„åˆ™ä½œä¸ºå¤‡ç”¨
          New-NetFirewallRule -DisplayName "RDP Port 3389" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow
          
          # é‡å¯RDPæœåŠ¡
          Write-Host "é‡å¯RDPæœåŠ¡..." -ForegroundColor Yellow
          Restart-Service -Name "TermService" -Force
          Start-Service -Name "TermService"
          
          Write-Host "RDPè®¾ç½®å®Œæˆï¼" -ForegroundColor Green
          
      - name: è·å–è¿æ¥ä¿¡æ¯
        run: |
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "è¿œç¨‹è¿æ¥ä¿¡æ¯" -ForegroundColor Cyan
          Write-Host "=============================================" -ForegroundColor Cyan
          
          # è·å–IPåœ°å€
          $ipconfig = ipconfig
          $ipv4 = $ipconfig | Select-String "IPv4" | ForEach-Object { ($_.ToString() -split ":")[1].Trim() }
          
          Write-Host "ğŸ–¥ï¸  è®¡ç®—æœºå: $env:COMPUTERNAME" -ForegroundColor Yellow
          Write-Host "ğŸŒ IPåœ°å€: $ipv4" -ForegroundColor Yellow
          Write-Host "ğŸ”‘ ç”¨æˆ·å: $env:USERNAME" -ForegroundColor Yellow
          Write-Host "ğŸ”’ å¯†ç : ${{ inputs.rdp_password }}" -ForegroundColor Red
          Write-Host "ğŸšª ç«¯å£: 3389" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "ğŸ“‹ è¿æ¥å‘½ä»¤: mstsc /v:$ipv4" -ForegroundColor Green
          Write-Host ""
          Write-Host "âš ï¸  æ³¨æ„: GitHub Actionsè¿è¡Œå™¨çš„ç½‘ç»œç¯å¢ƒå¯èƒ½é™åˆ¶å¤–éƒ¨è¿æ¥" -ForegroundColor Red
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
        run: |
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "âœ… å¹³è¡¡å‹ä¼˜åŒ–å®Œæˆ" -ForegroundColor Cyan
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ğŸ“Š ç£ç›˜çŠ¶æ€ï¼š" -ForegroundColor Yellow
          Get-PSDrive C | Format-Table Name, 
          @{Name="Used(GB)"; Expression={[math]::Round($_.Used/1GB,2)}}, 
          @{Name="Free(GB)"; Expression={[math]::Round($_.Free/1GB,2)}}, 
          @{Name="Total(GB)"; Expression={[math]::Round(($_.Used + $_.Free)/1GB,2)}}
          
          Write-Host "ğŸ§  å†…å­˜ä¿¡æ¯ï¼š" -ForegroundColor Yellow
          systeminfo | Select-String "Total Physical Memory", "Available Physical Memory"
          
          $freeGB = [math]::Round((Get-PSDrive C).Free/1GB, 2)
          Write-Host "ğŸ‰ Cç›˜å¯ç”¨ç©ºé—´: ${freeGB} GB" -ForegroundColor Green
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          if (Test-Path "start.ps1") {
            Write-Host "æ­£åœ¨å¯åŠ¨åº”ç”¨..." -ForegroundColor Yellow
            PowerShell -ExecutionPolicy Bypass -File start.ps1
          } elseif (Test-Path "start.bat") {
            Write-Host "æ­£åœ¨å¯åŠ¨æ‰¹å¤„ç†åº”ç”¨..." -ForegroundColor Yellow
            cmd /c start.bat
          } else {
            Write-Host "è­¦å‘Šï¼šæœªæ‰¾åˆ° start.ps1 æˆ– start.bat æ–‡ä»¶ï¼Œè·³è¿‡åº”ç”¨å¯åŠ¨" -ForegroundColor Yellow
          }
          
      - name: ä¿æŒå·¥ä½œæµè¿è¡Œ
        run: |
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "ğŸš€ å¯åŠ¨ä¿æ´»è¿›ç¨‹" -ForegroundColor Cyan
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host ""
          
          $durationMinutes = ${{ inputs.duration }}
          $durationSeconds = $durationMinutes * 60
          
          Write-Host "â±ï¸  è®¾ç½®è¿è¡Œæ—¶é•¿: $durationMinutes åˆ†é’Ÿ" -ForegroundColor Yellow
          Write-Host "ğŸ–¥ï¸  RDPæœåŠ¡è¿è¡Œä¸­..." -ForegroundColor Green
          Write-Host ""
          
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes($durationMinutes)
          $iteration = 0
          
          while ($(Get-Date) -lt $endTime) {
            $iteration++
            $currentTime = Get-Date
            $elapsed = $currentTime - $startTime
            $remaining = $endTime - $currentTime
            
            Write-Host "è¿è¡Œä¸­... å·²è¿è¡Œ: $([math]::Round($elapsed.TotalMinutes,1)) åˆ†é’Ÿ, å‰©ä½™: $([math]::Round($remaining.TotalMinutes,1)) åˆ†é’Ÿ, è¿­ä»£: $iteration"
            
            # æ£€æŸ¥RDPæœåŠ¡çŠ¶æ€
            $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
            if ($rdpService.Status -ne "Running") {
                Write-Host "é‡å¯RDPæœåŠ¡..." -ForegroundColor Yellow
                Start-Service -Name "TermService" -ErrorAction SilentlyContinue
            }
            
            Start-Sleep -Seconds 60
          }
          
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "â° å·²è¾¾åˆ°è®¾ç½®çš„è¿è¡Œæ—¶é•¿" -ForegroundColor Cyan
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "è¿è¡Œäº† $durationMinutes åˆ†é’Ÿï¼Œç°åœ¨é€€å‡º" -ForegroundColor Green
