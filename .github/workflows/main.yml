name: å¹³è¡¡å‹-Windows

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€
        run: |
          Write-Host "============================================="
          Write-Host "åˆå§‹ç³»ç»ŸçŠ¶æ€"
          Write-Host "============================================="
          Write-Host "å†…å­˜ä½¿ç”¨æƒ…å†µï¼š"
          systeminfo | Select-String "Total Physical Memory", "Available Physical Memory"
          Write-Host ""
          Write-Host "ç£ç›˜ç©ºé—´ï¼š"
          Get-PSDrive C | Format-Table Name, Used, Free, @{Name="Free(GB)"; Expression={[math]::Round($_.Free/1GB,2)}}, @{Name="Used(GB)"; Expression={[math]::Round($_.Used/1GB,2)}}
          Write-Host ""
          
      - name: åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶å’Œæ¸…ç†ç©ºé—´
        run: |
          Write-Host "============================================="
          Write-Host "æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶å’Œè½¯ä»¶"
          Write-Host "============================================="
          
          # è·å–æ¸…ç†å‰çš„ç©ºé—´
          $Before = (Get-PSDrive C).Free
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          # æ¸…ç†ç³»ç»Ÿç¼“å­˜
          Write-Host "æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
          Cleanmgr /sagerun:1 | Out-Null
          
          # æ¸…ç†NuGetç¼“å­˜
          Write-Host "æ¸…ç†NuGetç¼“å­˜..."
          Remove-Item -Path "$env:USERPROFILE\.nuget\packages\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          # æ¸…ç†npmç¼“å­˜
          Write-Host "æ¸…ç†npmç¼“å­˜..."
          npm cache clean --force 2>$null
          
          # æ¸…ç†pipç¼“å­˜
          Write-Host "æ¸…ç†pipç¼“å­˜..."
          pip cache purge 2>$null
          
          # æ¸…ç†Chromeç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          Write-Host "æ¸…ç†æµè§ˆå™¨ç¼“å­˜..."
          Remove-Item -Path "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Cache\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Cache\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          # æ¸…ç†Windowsæ›´æ–°ç¼“å­˜
          Write-Host "æ¸…ç†Windowsæ›´æ–°ç¼“å­˜..."
          Remove-Item -Path "C:\Windows\SoftwareDistribution\Download\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          # è¿è¡Œç£ç›˜æ¸…ç†
          Write-Host "è¿è¡Œç£ç›˜æ¸…ç†..."
          Start-Process -FilePath "cleanmgr" -ArgumentList "/sagerun:1" -Wait -NoNewWindow
          
          # è®¡ç®—é‡Šæ”¾çš„ç©ºé—´
          $After = (Get-PSDrive C).Free
          $FreedGB = [math]::Round(($After - $Before) / 1GB, 2)
          
          Write-Host ""
          Write-Host "æ€»å…±é‡Šæ”¾ç©ºé—´: $FreedGB GB"
          Write-Host ""
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        run: |
          Write-Host "============================================="
          Write-Host "âœ… Windowså¹³è¡¡å‹ä¼˜åŒ–å®Œæˆ"
          Write-Host "============================================="
          Write-Host ""
          Write-Host "ğŸ“Š ç£ç›˜çŠ¶æ€ï¼š"
          Get-PSDrive C | Format-Table Name, Used, Free, @{Name="Free(GB)"; Expression={[math]::Round($_.Free/1GB,2)}}, @{Name="Used(GB)"; Expression={[math]::Round($_.Used/1GB,2)}} -AutoSize
          Write-Host ""
          Write-Host "ğŸ§  å†…å­˜çŠ¶æ€ï¼š"
          systeminfo | Select-String "Total Physical Memory", "Available Physical Memory"
          Write-Host ""
          $FreeGB = [math]::Round((Get-PSDrive C).Free / 1GB, 2)
          Write-Host "ğŸ‰ Cç›˜å¯ç”¨ç©ºé—´: $FreeGB GB"
          Write-Host "============================================="
          Write-Host ""
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          if (Test-Path "start.ps1") {
            Write-Host "æ­£åœ¨å¯åŠ¨åº”ç”¨..."
            PowerShell -File start.ps1
          } elseif (Test-Path "start.bat") {
            Write-Host "æ­£åœ¨å¯åŠ¨åº”ç”¨..."
            cmd /c start.bat
          } elseif (Test-Path "start.sh") {
            Write-Host "æ£€æµ‹åˆ°start.shï¼Œå°è¯•ä½¿ç”¨Git Bashæˆ–WSLè¿è¡Œ..."
            bash start.sh
          } else {
            Write-Host "è­¦å‘Šï¼šæœªæ‰¾åˆ°å¯åŠ¨è„šæœ¬ï¼ˆstart.ps1ã€start.batæˆ–start.shï¼‰ï¼Œè·³è¿‡åº”ç”¨å¯åŠ¨"
          }
          
      - name: ä¿æŒå·¥ä½œæµè¿è¡Œ
        run: |
          Write-Host "============================================="
          Write-Host "ğŸš€ å¯åŠ¨ä¿æ´»è¿›ç¨‹"
          Write-Host "============================================="
          Write-Host ""
          
          $DurationMinutes = ${{ inputs.duration }}
          $DurationSeconds = $DurationMinutes * 60
          
          Write-Host "â±ï¸  è®¾ç½®è¿è¡Œæ—¶é•¿: $DurationMinutes åˆ†é’Ÿ"
          Write-Host ""
          
          $StartTime = Get-Date
          $EndTime = $StartTime.AddMinutes($DurationMinutes)
          $Iteration = 0
          
          while ($true) {
            $Iteration++
            $CurrentTime = Get-Date
            $Elapsed = $CurrentTime - $StartTime
            $Remaining = $EndTime - $CurrentTime
            
            if ($Remaining.TotalSeconds -le 0) {
              Write-Host "============================================="
              Write-Host "â° å·²è¾¾åˆ°è®¾ç½®çš„è¿è¡Œæ—¶é•¿"
              Write-Host "============================================="
              Write-Host "è¿è¡Œäº† $DurationMinutes åˆ†é’Ÿï¼Œç°åœ¨é€€å‡º"
              Write-Host ""
              break
            }
            
            # æ¯5åˆ†é’Ÿè¾“å‡ºä¸€æ¬¡çŠ¶æ€
            if ($Iteration % 10 -eq 1) {
              $ElapsedMin = [math]::Round($Elapsed.TotalMinutes, 1)
              $RemainingMin = [math]::Round($Remaining.TotalMinutes, 1)
              Write-Host "[$($CurrentTime.ToString('yyyy-MM-dd HH:mm:ss'))] å·²è¿è¡Œ: ${ElapsedMin}åˆ†é’Ÿ, å‰©ä½™: ${RemainingMin}åˆ†é’Ÿ"
            }
            
            Start-Sleep -Seconds 30
          }
          
          Write-Host "âœ… ä¿æ´»è¿›ç¨‹æ­£å¸¸ç»“æŸ"
