name: å¹³è¡¡å‹-Windows-ç¨³å®šç‰ˆ

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ä¿æ´»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: true
        default: '30'
        type: string
      rdp_password:
        description: 'è¿œç¨‹æ¡Œé¢è¿æ¥å¯†ç '
        required: true
        type: string
        default: 'GitHubRDP123'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€æ£€æŸ¥
        run: |
          Write-Host "============================================="
          Write-Host "âœ… ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¼€å§‹"
          Write-Host "============================================="
          
          # ç®€å•ç¨³å®šçš„ç£ç›˜æ£€æŸ¥
          try {
              $drive = Get-PSDrive C
              $usedGB = [math]::Round($drive.Used / 1GB, 2)
              $freeGB = [math]::Round($drive.Free / 1GB, 2)
              Write-Host "Cç›˜ç©ºé—´ - å·²ç”¨: ${usedGB}GB, å¯ç”¨: ${freeGB}GB"
          } catch {
              Write-Host "ç£ç›˜æ£€æŸ¥å®Œæˆ"
          }
          
          Write-Host "âœ… ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"
          
      - name: æ¸…ç†ç³»ç»Ÿç©ºé—´
        run: |
          Write-Host "============================================="
          Write-Host "ğŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´"
          Write-Host "============================================="
          
          # è®°å½•æ¸…ç†å‰ç©ºé—´
          try {
              $beforeSpace = (Get-PSDrive C).Free
              Write-Host "æ¸…ç†å‰ç©ºé—´: $([math]::Round($beforeSpace/1GB, 2)) GB"
          } catch {
              $beforeSpace = 0
          }
          
          # å®‰å…¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          Write-Host "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          Remove-Item -Path "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
          Remove-Item -Path "C:\Windows\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:USERPROFILE\AppData\Local\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue
          
          # æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜
          Write-Host "æ¸…ç†è½¯ä»¶åŒ…ç¼“å­˜..."
          if (Test-Path "$env:USERPROFILE\.nuget\packages") {
              Remove-Item -Path "$env:USERPROFILE\.nuget\packages\*" -Force -Recurse -ErrorAction SilentlyContinue
          }
          
          # å°è¯•Dockeræ¸…ç†
          if (Get-Command docker -ErrorAction SilentlyContinue) {
              Write-Host "æ¸…ç†Dockeré•œåƒ..."
              docker system prune -a -f 2>$null
          }
          
          # æ˜¾ç¤ºæ¸…ç†ç»“æœ
          try {
              $afterSpace = (Get-PSDrive C).Free
              if ($beforeSpace -gt 0) {
                  $freedSpace = $afterSpace - $beforeSpace
                  Write-Host "é‡Šæ”¾ç©ºé—´: $([math]::Round($freedSpace/1GB, 2)) GB"
              }
              Write-Host "å½“å‰å¯ç”¨ç©ºé—´: $([math]::Round($afterSpace/1GB, 2)) GB"
          } catch {
              Write-Host "æ¸…ç†å®Œæˆ"
          }
          
      - name: é…ç½®è¿œç¨‹æ¡Œé¢æœåŠ¡
        run: |
          Write-Host "============================================="
          Write-Host "ğŸ”§ é…ç½®è¿œç¨‹æ¡Œé¢æœåŠ¡"
          Write-Host "============================================="
          
          # å¯ç”¨è¿œç¨‹æ¡Œé¢
          Write-Host "å¯ç”¨è¿œç¨‹æ¡Œé¢..."
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
          
          # é…ç½®é˜²ç«å¢™
          Write-Host "é…ç½®é˜²ç«å¢™..."
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389 2>$null
          
          # è·å–IPåœ°å€
          $ipAddress = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          
          Write-Host "âœ… è¿œç¨‹æ¡Œé¢é…ç½®å®Œæˆ"
          Write-Host "IPåœ°å€: $ipAddress"
          Write-Host "ç«¯å£: 3389"
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: åˆ›å»ºè¿æ¥æ–‡ä»¶å’Œä¿¡æ¯é¡µé¢
        run: |
          Write-Host "============================================="
          Write-Host "ğŸŒ åˆ›å»ºè¿æ¥æ–‡ä»¶"
          Write-Host "============================================="
          
          $ipAddress = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          $password = "${{ inputs.rdp_password }}"
          
          # åˆ›å»ºRDPè¿æ¥æ–‡ä»¶
          $rdpContent = @"
screen mode id:i:2
use multimon:i:0
desktopwidth:i:1280
desktopheight:i:720
session bpp:i:32
winposstr:s:0,1,0,0,800,600
compression:i:1
keyboardhook:i:2
audiocapturemode:i:0
videoplaybackmode:i:1
connection type:i:7
networkautodetect:i:1
bandwidthautodetect:i:1
displayconnectionbar:i:1
enableworkspacereconnect:i:0
disable wallpaper:i:0
allow font smoothing:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:1
full address:s:$ipAddress
audiomode:i:0
redirectprinters:i:1
redirectcomports:i:0
redirectsmartcards:i:1
redirectclipboard:i:1
redirectposdevices:i:0
autoreconnection enabled:i:1
authentication level:i:2
prompt for credentials:i:0
negotiate security layer:i:1
remoteapplicationmode:i:0
alternate shell:s:
shell working directory:s:
gatewayhostname:s:
gatewayusagemethod:i:4
gatewaycredentialssource:i:4
gatewayprofileusagemethod:i:0
promptcredentialonce:i:0
gatewaybrokeringtype:i:0
use redirection server name:i:0
rdgiskdcproxy:i:0
kdcproxyname:s:
drivestoredirect:s:*
"@
          
          $rdpContent | Out-File -FilePath "windows-rdp.rdp" -Encoding ASCII
          Write-Host "âœ… RDPè¿æ¥æ–‡ä»¶å·²åˆ›å»º: windows-rdp.rdp"
          
          # åˆ›å»ºHTMLè¿æ¥é¡µé¢
          $htmlContent = @"
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows è¿œç¨‹æ¡Œé¢è¿æ¥</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        .content {
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-grid {
            display: grid;
            gap: 10px;
        }
        .info-item {
            display: flex;
            justify-content: between;
        }
        .info-label {
            font-weight: 600;
            color: #555;
            min-width: 100px;
        }
        .info-value {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 5px;
            flex: 1;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3498db;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-download {
            background: #27ae60;
        }
        .btn-download:hover {
            background: #219a52;
        }
        .footer {
            text-align: center;
            padding: 20px;
            background: #ecf0f1;
            color: #7f8c8d;
        }
        @media (max-width: 768px) {
            .content { grid-template-columns: 1fr; padding: 20px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Windows è¿œç¨‹æ¡Œé¢è¿æ¥</h1>
            <p>GitHub Actions è‡ªåŠ¨åŒ–ç¯å¢ƒ</p>
        </div>
        
        <div class="content">
            <div class="card">
                <h3>ğŸ”— è¿æ¥ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">IPåœ°å€:</span>
                        <code class="info-value" id="ip-address">$ipAddress</code>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ç«¯å£:</span>
                        <code class="info-value">3389</code>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ç”¨æˆ·å:</span>
                        <code class="info-value">runneradmin</code>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¯†ç :</span>
                        <code class="info-value">$password</code>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>âš¡ å¿«é€Ÿè¿æ¥</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                    <a href="windows-rdp.rdp" class="btn btn-download" download="github-remote-desktop.rdp">
                        ğŸ“¥ ä¸‹è½½RDPæ–‡ä»¶
                    </a>
                    <button class="btn" onclick="copyConnectionInfo()">
                        ğŸ“‹ å¤åˆ¶ä¿¡æ¯
                    </button>
                </div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h3>ğŸ“‹ è¿æ¥æ­¥éª¤</h3>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>ç‚¹å‡»ä¸Šæ–¹"ä¸‹è½½RDPæ–‡ä»¶"æŒ‰é’®</li>
                    <li>åŒå‡»ä¸‹è½½çš„RDPæ–‡ä»¶</li>
                    <li>è¾“å…¥ç”¨æˆ·å: <code>runneradmin</code></li>
                    <li>è¾“å…¥å¯†ç : <code>$password</code></li>
                    <li>ç‚¹å‡»è¿æ¥å³å¯è¿œç¨‹è®¿é—®</li>
                </ol>
            </div>
            
            <div class="card" style="grid-column: 1 / -1;">
                <h3>â±ï¸ ä¼šè¯çŠ¶æ€</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <strong>å¼€å§‹æ—¶é—´:</strong><br>
                        <span id="start-time">$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</span>
                    </div>
                    <div>
                        <strong>å‰©ä½™æ—¶é—´:</strong><br>
                        <span id="countdown">${{ inputs.duration }}</span> åˆ†é’Ÿ
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>GitHub Actions Windows Runner â€¢ è‡ªåŠ¨ç”Ÿæˆ</p>
        </div>
    </div>

    <script>
        function copyConnectionInfo() {
            const info = `IPåœ°å€: $ipAddress\nç«¯å£: 3389\nç”¨æˆ·å: runneradmin\nå¯†ç : $password`;
            navigator.clipboard.writeText(info).then(() => {
                alert('è¿æ¥ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
        
        // å€’è®¡æ—¶
        let minutes = ${{ inputs.duration }};
        const countdownEl = document.getElementById('countdown');
        const timer = setInterval(() => {
            if (minutes > 0) {
                minutes--;
                countdownEl.textContent = minutes;
            } else {
                clearInterval(timer);
                countdownEl.innerHTML = '<span style="color: #e74c3c;">å·²ç»“æŸ</span>';
            }
        }, 60000);
    </script>
</body>
</html>
"@
          
          $htmlContent | Out-File -FilePath "connection-guide.html" -Encoding UTF8
          Write-Host "âœ… è¿æ¥æŒ‡å—é¡µé¢å·²åˆ›å»º: connection-guide.html"
          
      - name: æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        run: |
          Write-Host "============================================="
          Write-Host "âœ… Windows å¹³è¡¡å‹ä¼˜åŒ–å®Œæˆ"
          Write-Host "============================================="
          Write-Host ""
          
          try {
              $drive = Get-PSDrive C
              $usedGB = [math]::Round($drive.Used / 1GB, 2)
              $freeGB = [math]::Round($drive.Free / 1GB, 2)
              $totalGB = [math]::Round(($drive.Used + $drive.Free) / 1GB, 2)
              
              Write-Host "ğŸ“Š å­˜å‚¨çŠ¶æ€ï¼š"
              Write-Host "   Cç›˜ - æ€»è®¡: ${totalGB}GB, å·²ç”¨: ${usedGB}GB, å¯ç”¨: ${freeGB}GB"
          } catch {
              Write-Host "å­˜å‚¨çŠ¶æ€: è·å–æˆåŠŸ"
          }
          
          $ipAddress = (Test-Connection -ComputerName $env:COMPUTERNAME -Count 1).IPV4Address.IPAddressToString
          
          Write-Host ""
          Write-Host "ğŸ”— è¿œç¨‹æ¡Œé¢è¿æ¥ï¼š"
          Write-Host "   IPåœ°å€: $ipAddress"
          Write-Host "   ç«¯å£: 3389"
          Write-Host "   ç”¨æˆ·å: runneradmin"
          Write-Host ""
          Write-Host "ğŸ“ ç”Ÿæˆæ–‡ä»¶ï¼š"
          Write-Host "   â€¢ windows-rdp.rdp (RDPè¿æ¥æ–‡ä»¶)"
          Write-Host "   â€¢ connection-guide.html (è¿æ¥æŒ‡å—)"
          Write-Host ""
          Write-Host "ğŸ‰ ç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼Œå¯è¿›è¡Œè¿œç¨‹è¿æ¥ï¼"
          Write-Host "============================================="
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          if (Test-Path "start.bat") {
              Write-Host "å¯åŠ¨åº”ç”¨..."
              Start-Process -FilePath "cmd.exe" -ArgumentList "/c start.bat" -WindowStyle Normal
          } elseif (Test-Path "start.ps1") {
              Write-Host "å¯åŠ¨PowerShellåº”ç”¨..."
              Start-Process -FilePath "powershell.exe" -ArgumentList "-File start.ps1" -WindowStyle Normal
          } else {
              Write-Host "æœªæ‰¾åˆ°å¯åŠ¨è„šæœ¬ï¼Œè·³è¿‡åº”ç”¨å¯åŠ¨"
          }
          
      - name: ä¿æŒå·¥ä½œæµè¿è¡Œ
        run: |
          Write-Host "============================================="
          Write-Host "ğŸš€ å¯åŠ¨ä¿æ´»è¿›ç¨‹"
          Write-Host "============================================="
          Write-Host ""
          
          $durationMinutes = ${{ inputs.duration }}
          $durationSeconds = $durationMinutes * 60
          
          Write-Host "â±ï¸ è®¾ç½®è¿è¡Œæ—¶é•¿: $durationMinutes åˆ†é’Ÿ"
          Write-Host ""
          
          # ç¡®ä¿è¿œç¨‹æ¡Œé¢æœåŠ¡è¿è¡Œ
          Start-Service "TermService" -ErrorAction SilentlyContinue
          
          $startTime = Get-Date
          $endTime = $startTime.AddMinutes($durationMinutes)
          $iteration = 0
          
          while ($true) {
              $iteration++
              $currentTime = Get-Date
              $remaining = $endTime - $currentTime
              
              if ($remaining.TotalSeconds -le 0) {
                  Write-Host "============================================="
                  Write-Host "â° å·²è¾¾åˆ°è®¾ç½®çš„è¿è¡Œæ—¶é•¿"
                  Write-Host "============================================="
                  Write-Host "è¿è¡Œäº† $durationMinutes åˆ†é’Ÿï¼Œç°åœ¨é€€å‡º"
                  break
              }
              
              $elapsedMinutes = [math]::Round(($currentTime - $startTime).TotalMinutes, 1)
              $remainingMinutes = [math]::Round($remaining.TotalMinutes, 1)
              
              Write-Host "[$iteration] å·²è¿è¡Œ: ${elapsedMinutes}åˆ†é’Ÿ, å‰©ä½™: ${remainingMinutes}åˆ†é’Ÿ"
              
              # å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€
              if ($iteration % 10 -eq 0) {
                  $service = Get-Service "TermService" -ErrorAction SilentlyContinue
                  if ($service.Status -ne "Running") {
                      Start-Service "TermService" -ErrorAction SilentlyContinue
                  }
              }
              
              Start-Sleep -Seconds 30
          }
